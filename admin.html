<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Адмін панель | Безпечне Місто Дніпро</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2rem;
            color: #0f172a;
            margin-bottom: 8px;
        }

        .header p {
            color: #64748b;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .card h2 {
            font-size: 1.25rem;
            color: #0f172a;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a8a;
        }

        .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #334155;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-weight: 500;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .hidden {
            display: none;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 24px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .back-link svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Назад на сайт
        </a>

        <div class="header">
            <h1>Адмін панель</h1>
            <p>Редагування контенту сайту "Безпечне Місто Дніпро"</p>
        </div>

        <div id="alert-success" class="alert alert-success hidden">
            Зміни успішно збережено!
        </div>

        <div id="alert-error" class="alert alert-error hidden">
            Помилка збереження. Перевірте, чи запущено сервер.
        </div>

        <div id="alert-info" class="alert alert-info hidden">
            Введіть URL вашого Apps Script Web App у налаштуваннях.
        </div>

        <div class="card" id="settings-card">
            <h2>Налаштування Google Sheets</h2>
            <div class="form-group">
                <label for="google_script_url">URL Apps Script Web App</label>
                <input type="url" id="google_script_url" placeholder="https://script.google.com/macros/s/...../exec">
                <p style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                    Цей URL ви отримаєте після розгортання Apps Script. Див. інструкцію в файлі <code>google-apps-script.js</code>
                </p>
            </div>
            <button type="button" class="btn btn-primary" id="save-settings-btn" style="margin-bottom: 0;">
                Зберегти налаштування
            </button>
        </div>

        <form id="admin-form">
            <div class="card">
                <h2>Головна секція (Hero)</h2>
                <div class="form-group">
                    <label for="hero_title">Заголовок</label>
                    <input type="text" id="hero_title" name="hero_title" placeholder="Безпечне Місто">
                </div>
                <div class="form-group">
                    <label for="hero_subtitle">Підзаголовок</label>
                    <input type="text" id="hero_subtitle" name="hero_subtitle" placeholder="Дніпро">
                </div>
                <div class="form-group">
                    <label for="hero_description">Опис</label>
                    <textarea id="hero_description" name="hero_description" placeholder="Опис програми..."></textarea>
                </div>
            </div>

            <div class="card">
                <h2>Фонове зображення</h2>
                <div class="form-group">
                    <label>Поточне зображення</label>
                    <div id="current-image-preview" style="margin-bottom: 16px; border-radius: 8px; overflow: hidden; max-width: 400px;">
                        <img id="hero_image_preview" src="" alt="Попередній перегляд" style="width: 100%; display: none; border-radius: 8px;">
                        <p id="no-image-text" style="color: #64748b; font-size: 0.9rem;">Зображення не встановлено</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="hero_image_file">Завантажити нове зображення</label>
                    <input type="file" id="hero_image_file" accept="image/*" style="padding: 12px; border: 2px dashed #e2e8f0; border-radius: 8px; width: 100%; cursor: pointer;">
                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                        Рекомендований розмір: 1920x1080 пікселів. Формати: JPG, PNG, WebP
                    </p>
                </div>
                <div id="upload-progress" class="hidden" style="margin-bottom: 16px;">
                    <div style="background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">
                        <div id="progress-bar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">Завантаження...</p>
                </div>
                <input type="hidden" id="hero_image" name="hero_image">
                <button type="button" class="btn btn-secondary" id="upload-image-btn" style="margin-top: 0;">
                    Завантажити зображення
                </button>
            </div>

            <div class="card">
                <h2>Статистика</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="stat_cameras">Камер встановлено</label>
                        <input type="text" id="stat_cameras" name="stat_cameras" placeholder="2 886+">
                    </div>
                    <div class="form-group">
                        <label for="stat_requests">Запитів оброблено</label>
                        <input type="text" id="stat_requests" name="stat_requests" placeholder="2 400+">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="stat_storage">Термін зберігання</label>
                        <input type="text" id="stat_storage" name="stat_storage" placeholder="30 днів">
                    </div>
                    <div class="form-group">
                        <label for="stat_monitoring">Моніторинг</label>
                        <input type="text" id="stat_monitoring" name="stat_monitoring" placeholder="24/7">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Посилання</h2>
                <div class="form-group">
                    <label for="telegram_link">Telegram бот</label>
                    <input type="url" id="telegram_link" name="telegram_link" placeholder="https://t.me/SaveCityDnipro_bot">
                </div>
                <div class="form-group">
                    <label for="form_individual_link">Форма для фізичних осіб</label>
                    <input type="url" id="form_individual_link" name="form_individual_link" placeholder="https://forms.gle/...">
                </div>
                <div class="form-group">
                    <label for="form_legal_link">Форма для юридичних осіб</label>
                    <input type="url" id="form_legal_link" name="form_legal_link" placeholder="https://forms.gle/...">
                </div>
            </div>

            <div class="card">
                <h2>Про програму</h2>
                <div class="form-group">
                    <label for="about_title">Заголовок секції</label>
                    <input type="text" id="about_title" name="about_title" placeholder="Про програму">
                </div>
                <div class="form-group">
                    <label for="about_description">Опис</label>
                    <textarea id="about_description" name="about_description" placeholder="Опис програми..."></textarea>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" id="save-btn">
                Зберегти зміни
            </button>
            <button type="button" class="btn btn-secondary" id="reset-btn">
                Скинути до початкових значень
            </button>
        </form>
    </div>

    <script>
        const form = document.getElementById('admin-form');
        const alertSuccess = document.getElementById('alert-success');
        const alertError = document.getElementById('alert-error');
        const alertInfo = document.getElementById('alert-info');
        const saveBtn = document.getElementById('save-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const googleScriptUrlInput = document.getElementById('google_script_url');
        const uploadImageBtn = document.getElementById('upload-image-btn');
        const heroImageFile = document.getElementById('hero_image_file');
        const heroImageInput = document.getElementById('hero_image');
        const heroImagePreview = document.getElementById('hero_image_preview');
        const noImageText = document.getElementById('no-image-text');
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');

        const defaultData = {
            hero_title: "Безпечне Місто",
            hero_subtitle: "Дніпро",
            hero_description: "Ми - Ситуаційний центр Дніпра. Працюємо в межах міської програми «Безпечне місто», яку реалізує КП «ІНФО-РАДА-ДНІПРО». Докладаємо максимум зусиль задля посилення нашої безпеки. Моніторимо міський простір, взаємодіємо з правоохоронними органами та службами екстреного реагування, відповідаємо на запити дніпрян щодо отримання відео з камер відеоспостереження. Ми поруч, на зв’язку і на сторожі безпеки 24/7.",
            hero_image: "",
            stat_cameras: "2 886+",
            stat_requests: "2 400+",
            stat_storage: "30 днів",
            stat_monitoring: "24/7",
            telegram_link: "https://t.me/SaveCityDnipro_bot",
            form_individual_link: "https://forms.gle/LqgvbhWfQq6xLwfz7",
            form_legal_link: "https://forms.gle/EAz4ziGbij3UTUab8",
            about_title: "Про програму",
            about_description: "Програма \"Безпечне місто\" реалізується з 2017 року для модернізації інфраструктури безпеки Дніпра."
        };

        // Завантажуємо збережені налаштування
        const savedUrl = localStorage.getItem('google_script_url');
        if (savedUrl) {
            googleScriptUrlInput.value = savedUrl;
        }

        function getGoogleScriptUrl() {
            return localStorage.getItem('google_script_url') || '';
        }

        function updateImagePreview(url) {
            if (url) {
                heroImagePreview.src = url;
                heroImagePreview.style.display = 'block';
                noImageText.style.display = 'none';
            } else {
                heroImagePreview.style.display = 'none';
                noImageText.style.display = 'block';
            }
        }

        function loadData() {
            const url = getGoogleScriptUrl();
            
            if (url) {
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        Object.keys(data).forEach(key => {
                            const input = document.getElementById(key);
                            if (input) input.value = data[key];
                        });
                        updateImagePreview(data.hero_image);
                    })
                    .catch(() => {
                        loadLocalData();
                    });
            } else {
                loadLocalData();
                alertInfo.classList.remove('hidden');
            }
        }

        function loadLocalData() {
            fetch('data.json')
                .then(response => response.json())
                .then(data => {
                    Object.keys(data).forEach(key => {
                        const input = document.getElementById(key);
                        if (input) input.value = data[key];
                    });
                    updateImagePreview(data.hero_image);
                })
                .catch(() => {
                    Object.keys(defaultData).forEach(key => {
                        const input = document.getElementById(key);
                        if (input) input.value = defaultData[key];
                    });
                });
        }

        function getFormData() {
            const data = {};
            Object.keys(defaultData).forEach(key => {
                const input = document.getElementById(key);
                if (input) data[key] = input.value || defaultData[key];
            });
            return data;
        }

        function showAlert(type, message) {
            alertSuccess.classList.add('hidden');
            alertError.classList.add('hidden');
            alertInfo.classList.add('hidden');
            
            if (type === 'success') {
                if (message) alertSuccess.textContent = message;
                alertSuccess.classList.remove('hidden');
                setTimeout(() => alertSuccess.classList.add('hidden'), 3000);
            } else if (type === 'error') {
                if (message) alertError.textContent = message;
                alertError.classList.remove('hidden');
            } else if (type === 'info') {
                if (message) alertInfo.textContent = message;
                alertInfo.classList.remove('hidden');
            }
        }

        // Конвертувати файл в base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Завантаження зображення на Google Drive через Apps Script
        async function uploadToGoogleDrive(file) {
            const url = getGoogleScriptUrl();
            if (!url) {
                throw new Error('Спочатку налаштуйте URL Apps Script Web App');
            }

            const base64Data = await fileToBase64(file);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'uploadImage',
                    imageData: base64Data,
                    mimeType: file.type,
                    fileName: 'hero-background.' + file.name.split('.').pop()
                })
            });

            const result = await response.json();
            
            if (result.success) {
                return result.imageUrl;
            } else {
                throw new Error(result.error || 'Помилка завантаження');
            }
        }

        // Кнопка завантаження зображення
        uploadImageBtn.addEventListener('click', async () => {
            const file = heroImageFile.files[0];
            if (!file) {
                showAlert('error', 'Спочатку виберіть файл зображення');
                return;
            }

            const url = getGoogleScriptUrl();
            if (!url) {
                showAlert('error', 'Спочатку налаштуйте URL Apps Script Web App');
                return;
            }

            uploadImageBtn.disabled = true;
            uploadImageBtn.textContent = 'Завантаження на Google Drive...';
            uploadProgress.classList.remove('hidden');
            progressBar.style.width = '30%';

            try {
                progressBar.style.width = '60%';
                const imageUrl = await uploadToGoogleDrive(file);
                progressBar.style.width = '100%';
                
                heroImageInput.value = imageUrl;
                updateImagePreview(imageUrl);
                
                showAlert('success', 'Зображення завантажено на Google Drive! Не забудьте натиснути "Зберегти зміни".');
            } catch (err) {
                showAlert('error', err.message);
            }

            uploadImageBtn.disabled = false;
            uploadImageBtn.textContent = 'Завантажити зображення';
            setTimeout(() => {
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
            }, 500);
        });

        // Зберегти налаштування
        saveSettingsBtn.addEventListener('click', () => {
            const url = googleScriptUrlInput.value.trim();
            
            if (url) {
                localStorage.setItem('google_script_url', url);
                showAlert('success', 'Налаштування збережено! Тепер завантажую дані з Google Sheets...');
                setTimeout(() => loadData(), 1000);
            } else {
                showAlert('error', 'Введіть URL Apps Script Web App');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = getGoogleScriptUrl();
            
            if (!url) {
                showAlert('error', 'Спочатку налаштуйте URL Apps Script Web App');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Збереження...';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(getFormData())
                });

                // no-cors mode не дозволяє читати відповідь, 
                // тому просто показуємо успіх якщо немає помилки
                showAlert('success', 'Дані відправлено в Google Sheets! Оновіть головну сторінку.');
            } catch (err) {
                showAlert('error', 'Помилка збереження: ' + err.message);
            }

            saveBtn.disabled = false;
            saveBtn.textContent = 'Зберегти зміни';
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            if (confirm('Ви впевнені, що хочете скинути всі значення до початкових?')) {
                Object.keys(defaultData).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) input.value = defaultData[key];
                });
            }
        });

        loadData();
    </script>

</body>
</html>
